{% extends "d3/layouts/main.html" %}

{% set pageName = "JSON sandpit" %}

{% block content %}
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<!-- Leaflet JS styles -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
crossorigin=""/>

<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin=""></script>


<style>
  #map { height: 420px; width:100%}
</style>
 
      <h1>{{pageName}}</h1>
<p>JSON is a useful format, so this page is an experiment about making JSON work with nunjucks and D3.</p>

<p>It's easy to load JSON using 'set':</p>
<!-- Example adapted from https://www.w3schools.com/whatis/whatis_json.asp -->
<!-- This example defines an employees object: an array of 3 employee records (objects): -->
{%
 set employees = [
    {"firstName":"John", "lastName":"Doe"},
    {"firstName":"Anna", "lastName":"Smith"},
    {"firstName":"Peter", "lastName":"Jones"}
]
  %}
<p>
  {% for item in employees %}
{{item.firstName}} {{item.lastName}} ... 
{% endfor %}
</p>

<!-- 

Map 
 
-->

<div id='map'></div>

<!-- <script src="https://leafletjs.com/examples/geojson/sample-geojson.js" type="text/javascript"></script>
 -->

 <!-- Load the extra JSON -->
 {% include "./sample-geojson.html" %}

<script>
  const map = L.map('map').setView([52.05, 0.72], 11);

const tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
}).addTo(map);

const baseballIcon = L.icon({
  iconUrl: 'baseball-marker.png',
  iconSize: [32, 37],
  iconAnchor: [16, 37],
  popupAnchor: [0, -28]
});

function onEachFeature(feature, layer) {
  let popupContent = `<p>I started out as a GeoJSON ${feature.geometry.type}, but now I'm a Leaflet vector!</p>`;

  if (feature.properties && feature.properties.popupContent) {
    popupContent += feature.properties.popupContent;
  }

  layer.bindPopup(popupContent);
}

/* global campus, bicycleRental, freeBus, coorsField */
const bicycleRentalLayer = L.geoJSON([bicycleRental, campus], {

  style(feature) {
    return feature.properties && feature.properties.style;
  },

  onEachFeature,

  pointToLayer(feature, latlng) {
    return L.circleMarker(latlng, {
      radius: 8,
      fillColor: '#ff7800',
      color: '#000',
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    });
  }
}).addTo(map);

const freeBusLayer = L.geoJSON(freeBus, {

  filter(feature, layer) {
    if (feature.properties) {
      // If the property "underConstruction" exists and is true, return false (don't render features under construction)
      return feature.properties.underConstruction !== undefined ? !feature.properties.underConstruction : true;
    }
    return false;
  },

  onEachFeature
}).addTo(map);

const coorsLayer = L.geoJSON(coorsField, {

  pointToLayer(feature, latlng) {
    return L.marker(latlng, {icon: baseballIcon});
  },

  onEachFeature
}).addTo(map);

</script>

<!--

    End of Main section

    -->
{% endblock %}