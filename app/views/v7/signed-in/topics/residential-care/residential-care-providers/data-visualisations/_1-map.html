<!-- Leaflet.js (CSS) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<!-- Leaflet.js (JavaScript) - Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<!-- Leaflet.markercluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<style>
  
  #map {
    height: 420px;
    width: 100%;
  }

  .popup {
    font-family: "GDS Transport", arial, sans-serif;
  }

  /* Attribution toggle styling */
  .leaflet-control-attribution-toggle {
    background: white;
    width: 26px;
    height: 26px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    color: #0b0c0c;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .leaflet-control-attribution-expanded {
    background: white;
    border: 2px solid #0b0c0c;
    padding: 6px 8px;
    border-radius: 4px;
    max-width: 250px;
    font-size: 14px;
    color: #0b0c0c;
    line-height: 1.3;
  }

  /* Leaflet.markercluster */
  .marker-cluster div {
    font-size: 1rem;
    font-weight: bold;
  }
  @media (min-width: 40.0625em) {
    .marker-cluster div {
      font-size: 1.1875rem;
    }
  }

</style>

<h4 class="govuk-heading-s">Figure 1: map of CQC-registered residential social care and community based adult social care service providers near {% if data.postcode1 %}postcode {{data.postcode1}}{% else %}postcode CO5 1ST for {{data.locationName or 'Shoggins Care Services (Sudbury)'}}{% endif %}</h4>

<div class="govuk-form-group">

  <div id="map">

  </div>

</div>

<div class="govuk-form-block">
  <p class="govuk-body data-source">Source: Care Directory from the Care Quality Commission (CQC)</p>
</div>

{% if data.postcode1 %}
<script>
  
  // Home location (Haverhill)
  var homeCoords = [52.084024, 0.446052];
  // Initialise the map ONCE, with attribution disabled
  var map = L.map('map', {
    attributionControl: false
  }).setView(homeCoords, 12);
  // --- Copywrite (©) map button ---
  var AttributionToggleControl = L.Control.extend({
    options: { position: 'bottomright' },

    onAdd: function () {
      var container = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');

      // The © button using Leaflet zoom control structure
      var link = L.DomUtil.create('a', 'leaflet-control-attribution-toggle', container);
      link.href = '#';
      link.title = 'Show map attribution';
      link.innerHTML = '&copy;'; // copyright symbol

      // Copywrite panel (hidden by default)
      var panel = L.DomUtil.create('div', 'leaflet-control-attribution-expanded', container);
      
      panel.style.display = 'none';
      panel.innerHTML = '&copy; OpenStreetMap contributors';

      L.DomEvent.disableClickPropagation(link);

      link.onclick = function (e) {
        L.DomEvent.preventDefault(e);

        // Toggle panel
        if (panel.style.display === 'none') {
          panel.style.display = 'block';
          link.title = 'Hide map attribution';
        }
        else {
          panel.style.display = 'none';
          link.title = 'Show map attribution';
        }
      };

      return container;
    }
  });

  map.addControl(new AttributionToggleControl());

  // Move default zoom buttons to bottom-right
  map.zoomControl.setPosition('bottomright');

  // Tile layer
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  // Postcode icon
  var homeIcon = L.icon({
    iconUrl: '/public/images/your-postcode.svg',
    iconSize: [40, 50],
    iconAnchor: [20, 50],
    popupAnchor: [0, -50]
  });

  // Home marker
  L.marker(homeCoords, { icon: homeIcon })
    .addTo(map)
    .bindPopup("<span class='popup'><strong>{{data.postcode1}}</strong></span>");

  // --- 5 mile radius circle (Sudbury) ---
  // 5 miles in metres
  var fiveMilesInMetres = 8046.72;
  var radiusCircle = L.circle(homeCoords, {
    color: '#1d70b8',
    fillColor: '#b1b4b6',
    fillOpacity: 0.25,
    radius: fiveMilesInMetres
  }).addTo(map);
  // --- Manual calculations around Sudbury (approx 5 miles) ---
  // Approx conversions at ~52°N:
  // 1 degree latitude ≈ 111.32 km
  // 1 degree longitude ≈ 111.32 * cos(52°) km ≈ 68.5 km
  // 5 miles ≈ 8.0467 km
  var deltaLat = 8.0467 / 111.32;   // ≈ 0.0723
  var deltaLng = 8.0467 / 68.5;     // ≈ 0.1174
  var southWest = L.latLng(homeCoords[0] - deltaLat, homeCoords[1] - deltaLng);
  var northEast = L.latLng(homeCoords[0] + deltaLat, homeCoords[1] + deltaLng);
  var circleBounds = L.latLngBounds(southWest, northEast);

  // Automatically zoom the map so this "5-mile box" (and thus the circle) is visible
  map.fitBounds(circleBounds);

  // --- Reset map view button ---
  var ResetMapControl = L.Control.extend({
    options: { position: 'bottomright' },

    onAdd: function () {
      var container = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');
      var link = L.DomUtil.create('a', 'leaflet-control-reset-map', container);
      
      link.href = '#';
      link.title = 'Reset map view';
      link.style.backgroundImage = "url('/public/images/reset-map-icon.png')";
      link.style.backgroundSize = '18px 18px';
      link.style.backgroundPosition = 'center';
      link.style.backgroundRepeat = 'no-repeat';
      link.style.width = '30px';
      link.style.height = '30px';

      L.DomEvent.disableClickPropagation(link);
      L.DomEvent.on(link, 'click', function (e) {
        L.DomEvent.preventDefault(e);
        map.fitBounds(circleBounds);
      });

      return container;
    }
  });

  // Add Reset Map View control AFTER zoom control repositioning
  map.addControl(new ResetMapControl());  

  // Create a clusters group
  var clusters = L.markerClusterGroup();

  // Markers
  var marker16 = L.marker([52.084312, 0.442187]);
  var marker17 = L.marker([52.090754, 0.455923]);
  var marker18 = L.marker([52.077981, 0.436512]);
  var marker19 = L.marker([52.071624, 0.449308]);
  var marker20 = L.marker([52.087159, 0.468911]);
  var marker21 = L.marker([52.095482, 0.432774]);
  var marker22 = L.marker([52.081237, 0.421905]);
  var marker23 = L.marker([52.074896, 0.462131]);
  var marker24 = L.marker([52.089021, 0.439782]);
  var marker25 = L.marker([52.082563, 0.452664]);
  var marker26 = L.marker([52.093317, 0.461209]);
  var marker27 = L.marker([52.079944, 0.429318]);
  
  // All markers are added to the clusters group
  clusters.addLayer(marker16);
  clusters.addLayer(marker17);
  clusters.addLayer(marker18);
  clusters.addLayer(marker19);
  clusters.addLayer(marker20);
  clusters.addLayer(marker21);
  clusters.addLayer(marker22);
  clusters.addLayer(marker23);
  clusters.addLayer(marker24);
  clusters.addLayer(marker25);
  clusters.addLayer(marker26);
  clusters.addLayer(marker27);

  // Add clusters to map
  map.addLayer(clusters);

  // Popups (Haverhill)
  marker16.bindPopup("<span class='popup'>Name: Haverhill Meadow View Care<br>Address: 3 Meadow View Court, Hales Barn Road, Haverhill, CB9 9DT<br>Services: Residential care<br>Distance from postcode: 0.17 miles</span>");
  marker17.bindPopup("<span class='popup'>Name: Chalkstone Nursing Lodge<br>Address: 21 Chalkstone Way, Haverhill, CB9 0LP<br>Services: Nursing<br>Distance from postcode: 0.63 miles</span>");
  marker18.bindPopup("<span class='popup'>Name: Stourfield Community Care<br>Address: Unit 2 Stourfield House, Camps Road, Haverhill, CB9 8HB<br>Services: Nursing, residential care<br>Distance from postcode: 0.58 miles</span>");
  marker19.bindPopup("<span class='popup'>Name: Hazelwood Domiciliary Services<br>Address: 18 Hazelwood Close, Haverhill, CB9 7RE<br>Services: Supported housing, home care<br>Distance from postcode: 0.87 miles</span>");
  marker20.bindPopup("<span class='popup'>Name: Cangle Court Care Home<br>Address: 7 Cangle Court, Ehringshausen Way, Haverhill, CB9 0BB<br>Services: Residential care<br>Distance from postcode: 0.99 miles</span>");
  marker21.bindPopup("<span class='popup'>Name: Eastfields Support Agency<br>Address: Suite 4 Eastfields Business Centre, Burton End, Haverhill, CB9 9QG<br>Services: Nursing<br>Distance from postcode: 0.97 miles</span>");
  marker22.bindPopup("<span class='popup'>Name: Millbrook House Supported Living<br>Address: 12 Millbrook Close, Withersfield Road, Haverhill, CB9 9LS<br>Services: Residential care<br>Distance from postcode: 1.04 miles</span>");
  marker23.bindPopup("<span class='popup'>Name: Ridgeway Homecare Services<br>Address: 5 Ridgeway Place, Coupals Road, Haverhill, CB9 7AE<br>Services: Nursing, home care<br>Distance from postcode: 0.93 miles</span>");
  marker24.bindPopup("<span class='popup'>Name: Blackthorpe Residential Lodge<br>Address: Blackthorpe Lodge, Manor Road, Haverhill, CB9 0SZ<br>Services: Residential care<br>Distance from postcode: 0.44 miles</span>");
  marker25.bindPopup("<span class='popup'>Name: Greenfields Outreach Support<br>Address: 9 Greenfields Court, Park Road, Haverhill, CB9 7PG<br>Services: Nursing<br>Distance from postcode: 0.30 miles</span>");
  marker26.bindPopup("<span class='popup'>Name: Orchard Gate Care Agency<br>Address: Unit 6 Orchard Gate, High Street, Haverhill, CB9 8AD<br>Services: Nursing, residential care<br>Distance from postcode: 0.91 miles</span>");
  marker27.bindPopup("<span class='popup'>Name: Fieldstone Community Support<br>Address: Fieldstone House, Duddery Hill, Haverhill, CB9 8EA<br>Services: Nursing, home care<br>Distance from postcode: 0.76 miles</span>");

</script>
{% else %}
<script>
  
  // Home location
  var homeCoords = [52.037456, 0.730166];
  // Initialise the map ONCE, with attribution disabled
  var map = L.map('map', {
    attributionControl: false
  }).setView(homeCoords, 12);
  // --- Copywrite (©) map button ---
  var AttributionToggleControl = L.Control.extend({
    options: { position: 'bottomright' },

    onAdd: function () {
      var container = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');

      // The © button using Leaflet zoom control structure
      var link = L.DomUtil.create('a', 'leaflet-control-attribution-toggle', container);
      link.href = '#';
      link.title = 'Show map attribution';
      link.innerHTML = '&copy;'; // copyright symbol

      // Copywrite panel (hidden by default)
      var panel = L.DomUtil.create('div', 'leaflet-control-attribution-expanded', container);
      
      panel.style.display = 'none';
      panel.innerHTML = '&copy; OpenStreetMap contributors';

      L.DomEvent.disableClickPropagation(link);

      link.onclick = function (e) {
        L.DomEvent.preventDefault(e);

        // Toggle panel
        if (panel.style.display === 'none') {
          panel.style.display = 'block';
          link.title = 'Hide map attribution';
        }
        else {
          panel.style.display = 'none';
          link.title = 'Show map attribution';
        }
      };

      return container;
    }
  });

  map.addControl(new AttributionToggleControl());

  // Move default zoom buttons to bottom-right
  map.zoomControl.setPosition('bottomright');

  // Tile layer
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  // Home icon
  var homeIcon = L.icon({
    iconUrl: '/public/images/your-care-home.svg',
    iconSize:     [40, 50],
    shadowSize:   [50, 64],
    iconAnchor:   [22, 94],
    shadowAnchor: [4, 62],
    popupAnchor:  [-3, -76]
  });

  // Home marker
  L.marker(homeCoords, { icon: homeIcon })
    .addTo(map)
    .bindPopup("<span class='popup'><strong>{{data.locationName or 'Shoggins Care Services (Sudbury)'}}</strong></span>");

  // --- 5 mile radius circle (Sudbury) ---
  // 5 miles in metres
  var fiveMilesInMetres = 8046.72;
  var radiusCircle = L.circle(homeCoords, {
    color: '#1d70b8',
    fillColor: '#b1b4b6',
    fillOpacity: 0.25,
    radius: fiveMilesInMetres
  }).addTo(map);
  // --- Manual calculations around Sudbury (approx 5 miles) ---
  // Approx conversions at ~52°N:
  // 1 degree latitude ≈ 111.32 km
  // 1 degree longitude ≈ 111.32 * cos(52°) km ≈ 68.5 km
  // 5 miles ≈ 8.0467 km
  var deltaLat = 8.0467 / 111.32;   // ≈ 0.0723
  var deltaLng = 8.0467 / 68.5;     // ≈ 0.1174
  var southWest = L.latLng(homeCoords[0] - deltaLat, homeCoords[1] - deltaLng);
  var northEast = L.latLng(homeCoords[0] + deltaLat, homeCoords[1] + deltaLng);
  var circleBounds = L.latLngBounds(southWest, northEast);

  // Automatically zoom the map so this "5-mile box" (and thus the circle) is visible
  map.fitBounds(circleBounds);

  // --- Reset map view button ---
  var ResetMapControl = L.Control.extend({
    options: { position: 'bottomright' },

    onAdd: function () {
      var container = L.DomUtil.create('div', 'leaflet-control-zoom leaflet-bar');
      var link = L.DomUtil.create('a', 'leaflet-control-reset-map', container);
      
      link.href = '#';
      link.title = 'Reset map view';
      link.style.backgroundImage = "url('/public/images/reset-map-icon.png')";
      link.style.backgroundSize = '18px 18px';
      link.style.backgroundPosition = 'center';
      link.style.backgroundRepeat = 'no-repeat';
      link.style.width = '30px';
      link.style.height = '30px';

      L.DomEvent.disableClickPropagation(link);
      L.DomEvent.on(link, 'click', function (e) {
        L.DomEvent.preventDefault(e);
        map.fitBounds(circleBounds);
      });

      return container;
    }
  });

  // Add Reset Map View control AFTER zoom control repositioning
  map.addControl(new ResetMapControl());  

  // Create a clusters group
  var clusters = L.markerClusterGroup();

  // Markers
  var marker1 = L.marker([52.079339, 0.747522]);
  var marker2 = L.marker([52.07887, 0.747719]);
  var marker3 = L.marker([52.039805, 0.745942]);
  var marker4 = L.marker([52.036340, 0.712279]);
  var marker5 = L.marker([52.079734, 0.719010]);
  var marker6 = L.marker([52.039719, 0.743473]);
  var marker7 = L.marker([52.033887, 0.756749]);
  var marker8 = L.marker([52.033352, 0.757328]);
  var marker9 = L.marker([52.039927, 0.74162]);
  var marker10 = L.marker([52.043122, 0.738511]);
  var marker11 = L.marker([52.048893, 0.725904]);
  var marker12 = L.marker([52.031762, 0.744288]);
  var marker13 = L.marker([52.075214, 0.758994]);
  var marker14 = L.marker([52.067831, 0.700122]);
  var marker15 = L.marker([52.056394, 0.736904]);
  
  // All markers are added to the clusters group
  clusters.addLayer(marker1);
  clusters.addLayer(marker2);
  clusters.addLayer(marker3);
  clusters.addLayer(marker4);
  clusters.addLayer(marker5);
  clusters.addLayer(marker6);
  clusters.addLayer(marker7);
  clusters.addLayer(marker8);
  clusters.addLayer(marker9);
  clusters.addLayer(marker10);
  clusters.addLayer(marker11);
  clusters.addLayer(marker12);
  clusters.addLayer(marker13);
  clusters.addLayer(marker14);
  clusters.addLayer(marker15);

  // Add clusters to map
  map.addLayer(clusters);

  // Popups (Sudbury)
  marker1.bindPopup("<span class='popup'>Name: 1 Oak Care Home<br>Address: Unit 1 &#38; 2 Woodview, Bull Lane Industrial Estate, Bull Lane, Acton, Sudbury, CO10 0FD<br>Services: Nursing<br>Distance from postcode: 3.2 miles</span>");
  marker2.bindPopup("<span class='popup'>Name: Briarcare Recruitment Agency<br>Address: Unit 3, Woodview, Bull Lane Industrial Estate, Bull Lane, Acton, Sudbury, CO10 0FD<br>Services: Nursing<br>Distance from postcode: 3.2 miles</span>");
  marker3.bindPopup("<span class='popup'>Name: Forest Care Home Suffolk<br>Address: Unit 22 South Suffolk Business Centre, Alexandra Road, Sudbury, CO10 2XH<br>Services: Nursing, residential care<br>Distance from postcode: 0.6 miles</span>");
  marker4.bindPopup("<span class='popup'>Name: Master Care Ipswich<br>Address: OFFICE 14, UNIT 5, STOUR VALLEY BUSINESS CENTRE, BRUNDON LANE, Sudbury, CO10 7GB<br>Services: Supported housing, supported living<br>Distance from postcode: 0.8 miles</span>");
  marker5.bindPopup("<span class='popup'>Name: Harmonize Care<br>Address: The Old Pharmacy, Hall Street, Long Melford, Sudbury, CO10 9JQ<br>Services: Homecare<br>Distance from postcode: 3 miles</span>");
  marker6.bindPopup("<span class='popup'>Name: Supporting An Independent Life<br>Address: Unit 14, South Suffolk Business Centre, Alexandra Road, Sudbury, CO10 2ZX<br>Services: Nursing<br>Distance from postcode: 0.6 miles</span>");
  marker7.bindPopup("<span class='popup'>Name: ivolve Suffolk Care Home<br>Address: Peter Dodd Mews, Shawlands Avenue,Great Cornard, Sudbury, CO10 0FY<br>Services: Residential care<br>Distance from postcode: 1.1 miles</span>");
  marker8.bindPopup("<span class='popup'>Name: Ivolve Shawlands Care Home<br>Address: Fieldview, Hare Field, Woodpecke, Shawlands Avenue, Great Cornard, Sudbury, CO10 0EW<br>Services: Residential care<br>Distance from postcode: 1.2 miles</span>");
  marker9.bindPopup("<span class='popup'>Name: Trust Care Home Solution South Suffolk Limited<br>Address: Unit 13, South Suffolk Business Centre, Alexandra Road, Sudbury, CO10 2ZX<br>Services: Nursing<br>Distance from postcode: 0.6 miles</span>");
  marker10.bindPopup("<span class='popup'>Name: Willowbrook Residential Care<br>Address: 2 Willowbrook Court, Alexandra Road, Sudbury, CO10 2YG<br>Services: Residential care<br>Distance from postcode: 0.7 miles</span>");
  marker11.bindPopup("<span class='popup'>Name: Cedar Path Support Services<br>Address: 14 Cedar Path, Hall Road, Long Melford, CO10 9JT<br>Services: Homecare<br>Distance from postcode: 2.8 miles</span>");
  marker12.bindPopup("<span class='popup'>Name: Brookside Assisted Living<br>Address: 9 Brookside Way, Great Cornard, Sudbury, CO10 0DL<br>Services: Residential care<br>Distance from postcode: 1.3 miles</span>");
  marker13.bindPopup("<span class='popup'>Name: Maple House Care Agency<br>Address: Unit 5 Maple Court, Bull Lane Industrial Estate, Acton, Sudbury, CO10 0FH<br>Services: Nursing<br>Distance from postcode: 3.1 miles</span>");
  marker14.bindPopup("<span class='popup'>Name: Orchard View Homecare<br>Address: 87 Orchard View, Newton Road, Sudbury, CO10 0QS<br>Services: Supported living, home care<br>Distance from postcode: 3.4 miles</span>");
  marker15.bindPopup("<span class='popup'>Name: Stonehill Community Care<br>Address: 11 Stonehill Close, Great Cornard, Sudbury, CO10 0FE<br>Services: Residential care<br>Distance from postcode: 1.0 miles</span>");

</script>
{% endif %}